@page "/"
@using TicketingFE.Extensions
@using TicketingFE.Models
@inject IJSRuntime JS
@inject NavigationManager Nav

@inject TicketApiService TicketService
@inject UserApiService UserService

<PageTitle>Ticketing Home</PageTitle>

<MudGrid class="pt-3">
    <MudItem xs="6">
        <MudButton Color="Color.Primary" 
            Variant="Variant.Filled" 
            Href="/ticket"
            Id="CreateTicket">
        Create New Ticket
        </MudButton>
    </MudItem>
    <MudItem xs="3">
    @if(Users != null && Users.Any())
    {
        <MudSelect T="Guid?" 
                @bind-Value="SelectedUserId"
                Clearable
                Placeholder="Select User"
                Id=SelectUser>
            @foreach(UserViewModel user in Users)
            {
                <MudSelectItem Value="@user.Id">@user.Name</MudSelectItem>
            }
        </MudSelect>
    }
    </MudItem>
    <MudItem xs="3">
        <MudSelect T="string"
            @bind-Value="SelectedStatus"
            Clearable
            Placeholder="Select Status"
            Id=SelectStatus>
                <MudSelectItem T="string" Value="@("open")">Open</MudSelectItem>
                <MudSelectItem T="string" Value="@("inprogress")">In Progress</MudSelectItem>
                <MudSelectItem T="string" Value="@("closed")">Closed</MudSelectItem>
        </MudSelect>
    </MudItem>
</MudGrid>

<MudTable 
    Items="@Tickets" 
    Hover="true" 
    Breakpoint="Breakpoint.Sm" 
    Loading="@_loading" 
    LoadingProgressColor="Color.Info"
    @bind-SelectedItem="SelectedTicket"
    Id="TicketTable">
    <HeaderContent>
        <MudTh>No.</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Description</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Assigned User</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="No.">@context?.TicketNo</MudTd>
        <MudTd DataLabel="Title">@context?.Title</MudTd>
        <MudTd DataLabel="Description">@context?.Description</MudTd>
        <MudTd DataLabel="Status" HideSmall="_hidePosition">@context?.TicketStatusDisplay</MudTd>
        <MudTd DataLabel="Assigned User">@context?.AssignedUser?.Name</MudTd>
    </RowTemplate>
</MudTable>


@code {
    private bool _hidePosition;
    private bool _loading;

    private List<(string Value, string DisplayName)> statusOptions = new();
    private List<TicketViewModel>? Tickets { get; set; }
    private List<UserViewModel>? Users { get; set; }
    private Guid? _selectedUserId = null;

    private TicketViewModel? _selectedTicket = null;
    private TicketViewModel? SelectedTicket
    {
         get => _selectedTicket;
         set {
            if(_selectedTicket != value)
            {
                _selectedTicket = value;
                NavigateToTicket();
            }
         }
    }
    private Guid? SelectedUserId {
        get => _selectedUserId;
         set {
            if(_selectedUserId != value)
            {
                _selectedUserId = value;
                _ = LoadTicketsAsync();
            }
         }
    }
    private string? _selectedStatus;

    private string? SelectedStatus {
        get => _selectedStatus;
         set {
            if(_selectedStatus != value)
            {
                _selectedStatus = value;
                _ = LoadTicketsAsync();
            }
         }
    }
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _loading = true;

            var ticketTask = TicketService.GetTicketsAsync(new TicketQuery());
            var userTask = UserService.GetUsersAsync();

            await Task.WhenAll(ticketTask, userTask);

            Tickets = ticketTask.Result?
                .Select(x => x.ToViewModel())
                .OrderBy(x => x.TicketNo)
                .ToList();
            Users = userTask.Result?
                .Select(x => x.ToViewModel())
                .ToList();

        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error on initial load: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadTicketsAsync()
    {
        try
        {
            TicketQuery query = new TicketQuery
            {
                Status = SelectedStatus,
                UserId = SelectedUserId.ToString()
            };

            var ticketsDTO = await TicketService.GetTicketsAsync(query);
            Tickets = ticketsDTO
                .Select(x => x.ToViewModel())
                .OrderBy(x =>x.TicketNo)
                .ToList();

            _ = InvokeAsync(StateHasChanged);
            _ = LogToConsole("Tickets Loaded");
        }
        catch(Exception ex)
        {
            Console.Error.WriteLine($"Error loading tickets: {ex.Message}");
        }
    }

    private async Task LogToConsole(string message)
    {
        await JS.InvokeVoidAsync("console.log", message);
    }

    private void NavigateToTicket()
    {
        if(SelectedTicket != null)
        {
            Nav.NavigateTo($"/ticket/{SelectedTicket.TicketNo}");
        }
    }
}